<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Embed an `Info.plist` or `launchd.plist` file directly in your executable binary, brought to you by @NikolaiVazquez!"><title>embed_plist - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-5bc39a1768837dd0.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="embed_plist" data-themes="" data-resource-suffix="" data-rustdoc-version="1.77.2 (25ef9e3d8 2024-04-09)" data-channel="1.77.2" data-search-js="search-dd67cee4cfa65049.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../static.files/storage-4c98445ec4002617.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-48f368f3872407c8.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-04d5337699b92874.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button><a class="logo-container" href="../embed_plist/index.html"><img src="https://raw.githubusercontent.com/nvzqz/embed-plist-rs/main/img/icon.svg?sanitize=true" alt=""></a></nav><nav class="sidebar"><div class="sidebar-crate"><a class="logo-container" href="../embed_plist/index.html"><img src="https://raw.githubusercontent.com/nvzqz/embed-plist-rs/main/img/icon.svg?sanitize=true" alt="logo"></a><h2><a href="../embed_plist/index.html">embed_plist</a><span class="version">1.2.2</span></h2></div><div class="sidebar-elems"><ul class="block">
            <li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#macros">Macros</a></li><li><a href="#functions">Functions</a></li></ul></section></div></nav><div class="sidebar-resizer"></div>
    <main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../embed_plist/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">embed_plist</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="src" href="../src/embed_plist/lib.rs.html#1-684">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><div align="center" style="margin-bottom:1.5rem;">
    <a href="https://github.com/nvzqz/embed-plist-rs">
        <img src="https://raw.githubusercontent.com/nvzqz/embed-plist-rs/main/img/icon.svg?sanitize=true"
             height="200px">
        <h1 style="font-size:2rem;margin-top:0;">embed_plist</h1>
    </a>
    <a href="https://crates.io/crates/embed_plist">
        <img src="https://img.shields.io/crates/v/embed_plist.svg" alt="crates.io">
        <img src="https://img.shields.io/crates/d/embed_plist.svg" alt="downloads">
    </a>
    <a href="https://github.com/nvzqz/embed-plist-rs/actions?query=workflow%3Aci">
        <img src="https://github.com/nvzqz/embed-plist-rs/workflows/ci/badge.svg" alt="build status">
    </a>
    <img src="https://img.shields.io/badge/rustc-^1.39.0-blue.svg" alt="rustc ^1.39.0">
</div>
<p>Embed an <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Introduction/Introduction.html"><code>Info.plist</code></a> or <a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/TP40001762-104142"><code>launchd.plist</code></a> file directly in your
executable binary, brought to you by <a href="https://twitter.com/NikolaiVazquez">@NikolaiVazquez</a>!</p>
<p>If you found this library useful, please consider
<a href="https://github.com/sponsors/nvzqz">sponsoring me on GitHub</a>. ❤️</p>
<h2 id="index"><a class="doc-anchor" href="#index">§</a>Index</h2>
<ol>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#minimum-supported-rust-version">Minimum Supported Rust Version</a></li>
<li><a href="#multi-target-considerations">Multi-Target Considerations</a></li>
<li><a href="#get-embedded-property-lists">Get Embedded Property Lists</a></li>
<li><a href="#accidental-reuse-protection">Accidental Reuse Protection</a></li>
<li><a href="#implementation">Implementation</a></li>
<li><a href="#license">License</a></li>
<li><a href="#macros">Macros</a></li>
<li><a href="#functions">Functions</a></li>
</ol>
<h2 id="motivation"><a class="doc-anchor" href="#motivation">§</a>Motivation</h2>
<p>Certain programs require an embedded <code>Info.plist</code> or <code>launchd.plist</code> file to
work correctly. For example:</p>
<ul>
<li>
<p><code>Info.plist</code> is needed to obtain certain permissions on macOS 10.15 and
later.</p>
</li>
<li>
<p><code>launchd.plist</code> is needed to make
<a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html"><code>launchd</code> daemons and user agents</a>.</p>
</li>
</ul>
<p>Doing this manually with <a href="https://doc.rust-lang.org/std/macro.include_bytes.html"><code>include_bytes!</code></a> is cumbersome. To understand
why, see the <a href="#implementation">implementation</a>. This library removes the
headache of doing this.</p>
<h2 id="usage"><a class="doc-anchor" href="#usage">§</a>Usage</h2>
<p>This library is available <a href="https://crates.io/crates/embed_plist">on crates.io</a> and can be used by adding
the following to your project’s <a href="https://doc.rust-lang.org/cargo/reference/manifest.html"><code>Cargo.toml</code></a>:</p>
<div class="example-wrap"><pre class="language-toml"><code>[dependencies]
embed_plist = &quot;1.2&quot;
</code></pre></div>
<p>…and this to any source file in your crate:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">embed_plist::embed_info_plist!</span>(<span class="string">"Info.plist"</span>);

<span class="comment">// If making a daemon:
</span><span class="macro">embed_plist::embed_launchd_plist!</span>(<span class="string">"launchd.plist"</span>);</code></pre></div>
<p>Done! It’s that simple. 🙂</p>
<p>See <a href="#implementation">implementation</a> for details on this sorcery.</p>
<h2 id="minimum-supported-rust-version"><a class="doc-anchor" href="#minimum-supported-rust-version">§</a>Minimum Supported Rust Version</h2>
<p>This library targets <b>1.39</b> as its minimum supported Rust version
(MSRV).</p>
<p>Requiring a newer Rust version is considered a breaking change and will
result in a “major” library version update. In other words: <code>0.1.z</code> would
become <code>0.2.0</code>, or <code>1.y.z</code> would become <code>2.0.0</code>.</p>
<h2 id="multi-target-considerations"><a class="doc-anchor" href="#multi-target-considerations">§</a>Multi-Target Considerations</h2>
<p>This library only works for <a href="https://en.wikipedia.org/wiki/Mach-O">Mach-O</a>
binaries. When building a cross-platform program, these macro calls should
be placed behind a <code>#[cfg]</code> to prevent linker errors on other targets.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[cfg(target_os = <span class="string">"macos"</span>)]
</span><span class="macro">embed_plist::embed_info_plist!</span>(<span class="string">"Info.plist"</span>);</code></pre></div>
<h2 id="get-embedded-property-lists"><a class="doc-anchor" href="#get-embedded-property-lists">§</a>Get Embedded Property Lists</h2>
<p>After using these macros, you can get their contents by calling
<a href="fn.get_info_plist.html"><code>get_info_plist</code></a> or <a href="fn.get_launchd_plist.html"><code>get_launchd_plist</code></a> from anywhere in your program.</p>
<p>We can verify that the result is correct by checking it against reading the
appropriate file at runtime:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">embed_plist::embed_info_plist!</span>(<span class="string">"Info.plist"</span>);

<span class="kw">let </span>embedded_plist = embed_plist::get_info_plist();
<span class="kw">let </span>read_plist = std::fs::read(<span class="string">"Info.plist"</span>)<span class="question-mark">?</span>;

<span class="macro">assert_eq!</span>(embedded_plist, read_plist.as_slice());</code></pre></div>
<p>If the appropriate macro has not been called, each function creates a
compile-time error by failing to reference the symbol defined by that macro:</p>

<div class="example-wrap compile_fail"><a href="#" class="tooltip" title="This example deliberately fails to compile">ⓘ</a><pre class="rust rust-example-rendered"><code><span class="kw">let </span>embedded_plist = embed_plist::get_info_plist();</code></pre></div>
<h2 id="accidental-reuse-protection"><a class="doc-anchor" href="#accidental-reuse-protection">§</a>Accidental Reuse Protection</h2>
<p>Only one copy of <code>Info.plist</code> or <code>launchd.plist</code> should exist in a binary.
Accidentally embedding them multiple times would break tools that read these
sections.</p>
<p>Fortunately, this library makes reuse a compile-time error! This protection
works even if these macros are reused in different modules.</p>

<div class="example-wrap compile_fail"><a href="#" class="tooltip" title="This example deliberately fails to compile">ⓘ</a><pre class="rust rust-example-rendered"><code><span class="macro">embed_plist::embed_info_plist!</span>(<span class="string">"Info.plist"</span>);
<span class="macro">embed_plist::embed_info_plist!</span>(<span class="string">"Info.plist"</span>);</code></pre></div>
<p>This example produces the following error:</p>
<div class="example-wrap"><pre class="language-txt"><code>error: symbol `_EMBED_INFO_PLIST` is already defined
 --&gt; src/main.rs:4:1
  |
4 | embed_plist::embed_info_plist!(&quot;Info.plist&quot;);
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |
  = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)

error: aborting due to previous error
</code></pre></div><p style="background:rgba(255, 181, 77, 0.16);padding:0.75em;">
<b>Warning:</b> Although the name
<code style="background:rgba(41, 24, 0, 0.1);">_EMBED_INFO_PLIST</code>
can be seen here, you <strong>should not</strong> reference this symbol with
e.g. an
<code style="background:rgba(41, 24, 0, 0.1);">extern "C"</code>
block. I reserve the right to change this name in a SemVer-compatible
update.
</p>
<h2 id="implementation"><a class="doc-anchor" href="#implementation">§</a>Implementation</h2>
<p>Files are read using <a href="https://doc.rust-lang.org/std/macro.include_bytes.html"><code>include_bytes!</code></a>. This normally places data in
<code>__TEXT,__const</code>, where immutable data is kept. However, property list data
is expected to be in <code>__TEXT,__info_plist</code> or <code>__TEXT,__launchd_plist</code>. This
section will explain how I accomplish that.</p>
<p>We begin by reading the file from disk:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">const </span>BYTES: <span class="kw-2">&amp;</span>[u8] = <span class="macro">include_bytes!</span>(<span class="string">"Info.plist"</span>);</code></pre></div>
<p>A naïve approach is to do the following:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[used] </span><span class="comment">// Prevent optimizing out
</span><span class="attr">#[link_section = <span class="string">"__TEXT,__info_plist"</span>]
</span><span class="kw">static </span>PLIST: <span class="kw-2">&amp;</span>[u8] = BYTES;</code></pre></div>
<p>This doesn’t work because only the slice’s pointer and length that are
placed in <code>__TEXT,__info_plist</code>. The referenced bytes are still placed in
<code>__TEXT,__const</code>.</p>
<p>Instead, we need to arrive at the following:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[used]
#[link_section = <span class="string">"__TEXT,__info_plist"</span>]
</span><span class="kw">static </span>PLIST: [u8; N] = <span class="kw-2">*</span>BYTES;</code></pre></div>
<p>We can get <code>N</code> by using <a href="https://doc.rust-lang.org/std/primitive.slice.html#method.len"><code>len</code></a>. As of Rust 1.39, it is possible to get the
length of a slice within a <code>const</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">const </span>N: usize = BYTES.len();</code></pre></div>
<p>The next step is to dereference the bytes into a <code>[u8; N]</code>.</p>
<p>There are two approaches:</p>
<ol>
<li>
<p><span id="approach-1"></span>Call <a href="https://doc.rust-lang.org/std/macro.include_bytes.html"><code>include_bytes!</code></a> again.</p>
<p>This is not the approach used by this library because of concerns about
compile performance. See the <a href="#approach-2">second approach</a> for what this
library does.</p>
<p>The following is all we need:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[used]
#[link_section = <span class="string">"__TEXT,__info_plist"</span>]
</span><span class="kw">static </span>PLIST: [u8; N] = <span class="kw-2">*</span><span class="macro">include_bytes!</span>(<span class="string">"Info.plist"</span>);</code></pre></div>
<p>This works because <code>include_bytes!</code> actually returns a <code>&amp;[u8; N]</code>. It’s
often used as a <code>&amp;[u8]</code> because we don’t know the size when calling it.</p>
</li>
<li>
<p><span id="approach-2"></span>Dereference our current bytes through
pointer casting.</p>
<p>This is tricker than the <a href="#approach-1">first approach</a> (and somewhat
cursed). If you know me, then it’s predictable I’d go this route.</p>
<p>We can get a pointer to the bytes via <a href="https://doc.rust-lang.org/std/primitive.slice.html#method.as_ptr"><code>as_ptr</code></a>, which is usable in
<code>const</code>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">const </span>PTR: <span class="kw-2">*const </span>[u8; N] = BYTES.as_ptr() <span class="kw">as </span><span class="kw-2">*const </span>[u8; N];</code></pre></div>
<p>Unfortunately, this pointer can’t be directly dereferenced in Rust 1.39
(minimum supported version).</p>

<div class="example-wrap compile_fail"><a href="#" class="tooltip" title="This example deliberately fails to compile">ⓘ</a><pre class="rust rust-example-rendered"><code><span class="attr">#[used]
#[link_section = <span class="string">"__TEXT,__info_plist"</span>]
</span><span class="kw">static </span>PLIST: [u8; N] = <span class="kw">unsafe </span>{ <span class="kw-2">*</span>PTR };</code></pre></div>
<p>Instead, we must cast the pointer to a reference.</p>
<p>You may want to reach for <a href="https://doc.rust-lang.org/std/mem/fn.transmute.html"><code>transmute</code></a>, which was stabilized for use in
<code>const</code> in Rust 1.46. However, earlier versions need to be supported, so
that is not an option for this library.</p>
<p>This bitwise cast can be accomplished with a <code>union</code>:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">union </span>Transmute {
    from: <span class="kw-2">*const </span>[u8; N],
    into: <span class="kw-2">&amp;</span><span class="lifetime">'static </span>[u8; N],
}

<span class="kw">const </span>REF: <span class="kw-2">&amp;</span>[u8; N] = <span class="kw">unsafe </span>{ Transmute { from: PTR }.into };</code></pre></div>
<p>Finally, we can dereference our bytes:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="attr">#[used]
#[link_section = <span class="string">"__TEXT,__info_plist"</span>]
</span><span class="kw">static </span>PLIST: [u8; N] = <span class="kw-2">*</span>REF;</code></pre></div>
</li>
</ol>
<h2 id="license"><a class="doc-anchor" href="#license">§</a>License</h2>
<p>This project is released under either:</p>
<ul>
<li><a href="https://github.com/nvzqz/embed-plist-rs/blob/master/LICENSE-MIT">MIT License</a></li>
<li><a href="https://github.com/nvzqz/embed-plist-rs/blob/master/LICENSE-APACHE">Apache License (Version 2.0)</a></li>
</ul>
<p>at your choosing.</p>
</div></details><h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="macro" href="macro.embed_info_plist.html" title="macro embed_plist::embed_info_plist">embed_info_plist</a></div><div class="desc docblock-short">Embeds the <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Introduction/Introduction.html"><code>Info.plist</code></a> file at <code>$path</code> directly in the current binary.</div></li><li><div class="item-name"><a class="macro" href="macro.embed_info_plist_bytes.html" title="macro embed_plist::embed_info_plist_bytes">embed_info_plist_bytes</a></div><div class="desc docblock-short">Embeds the <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Introduction/Introduction.html"><code>Info.plist</code></a> file in <code>&amp;[u8]</code> directly in the current binary.</div></li><li><div class="item-name"><a class="macro" href="macro.embed_launchd_plist.html" title="macro embed_plist::embed_launchd_plist">embed_launchd_plist</a></div><div class="desc docblock-short">Embeds the <a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/TP40001762-104142"><code>launchd.plist</code></a> file at <code>$path</code> directly in the current binary.</div></li><li><div class="item-name"><a class="macro" href="macro.embed_launchd_plist_bytes.html" title="macro embed_plist::embed_launchd_plist_bytes">embed_launchd_plist_bytes</a></div><div class="desc docblock-short">Embeds the <a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/TP40001762-104142"><code>launchd.plist</code></a> file in <code>&amp;[u8]</code> directly in the current binary.</div></li></ul><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.get_info_plist.html" title="fn embed_plist::get_info_plist">get_info_plist</a></div><div class="desc docblock-short">Returns the contents of the embedded <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Introduction/Introduction.html"><code>Info.plist</code></a> file.</div></li><li><div class="item-name"><a class="fn" href="fn.get_launchd_plist.html" title="fn embed_plist::get_launchd_plist">get_launchd_plist</a></div><div class="desc docblock-short">Returns the contents of the embedded <a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/TP40001762-104142"><code>launchd.plist</code></a> file.</div></li></ul></section></div></main></body></html>